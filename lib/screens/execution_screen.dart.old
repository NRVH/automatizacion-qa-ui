import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:file_picker/file_picker.dart';
import 'dart:io';
import '../providers/app_state_provider.dart';
import '../services/script_executor_service.dart';

class ExecutionScreen extends StatefulWidget {
  const ExecutionScreen({super.key});

  @override
  State<ExecutionScreen> createState() => _ExecutionScreenState();
}

class _ExecutionScreenState extends State<ExecutionScreen> {
  AvailableScript? _selectedScript;
  List<AvailableScript> _availableScripts = [];
  bool _loadingScripts = true;
  final ScrollController _scrollController = ScrollController();

  @override
  void initState() {
    super.initState();
    _loadAvailableScripts();
  }

  Future<void> _loadAvailableScripts() async {
    final appState = Provider.of<AppStateProvider>(context, listen: false);
    
    if (!appState.isRepositoryCloned) {
      setState(() {
        _loadingScripts = false;
      });
      return;
    }

    try {
      final scripts = await appState.scriptService.getAvailableScripts();
      setState(() {
        _availableScripts = scripts;
        
        // Intentar restaurar el script previamente seleccionado
        if (appState.selectedScriptName != null && scripts.isNotEmpty) {
          final previousScript = scripts.firstWhere(
            (s) => s.name == appState.selectedScriptName,
            orElse: () => scripts.first,
          );
          _selectedScript = previousScript;
        } else if (scripts.isNotEmpty) {
          _selectedScript = scripts.first;
        }
        
        _loadingScripts = false;
      });
    } catch (e) {
      setState(() {
        _loadingScripts = false;
      });
    }
  }

  @override
  void dispose() {
    _scrollController.dispose();
    super.dispose();
  }

  void _scrollToBottom() {
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (_scrollController.hasClients) {
        _scrollController.animateTo(
          _scrollController.position.maxScrollExtent,
          duration: const Duration(milliseconds: 300),
          curve: Curves.easeOut,
        );
      }
    });
  }

  Future<void> _stopExecution() async {
    final appState = Provider.of<AppStateProvider>(context, listen: false);

    // Confirmar con el usuario
    final shouldStop = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Row(
          children: [
            Icon(Icons.warning, color: Colors.orange),
            SizedBox(width: 12),
            Text('Detener Ejecuci√≥n'),
          ],
        ),
        content: const Text(
          '¬øEst√°s seguro de que deseas detener la ejecuci√≥n actual?\n\n'
          'Esto terminar√° el proceso inmediatamente y puede dejar la operaci√≥n incompleta.',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: const Text('Cancelar'),
          ),
          FilledButton(
            onPressed: () => Navigator.pop(context, true),
            style: FilledButton.styleFrom(backgroundColor: Colors.red),
            child: const Text('Detener'),
          ),
        ],
      ),
    );

    if (shouldStop != true) return;

    try {
      final stopped = await appState.scriptService.stopCurrentExecution();
      
      if (stopped) {
        appState.addTerminalOutput('');
        appState.addTerminalOutput('üõë ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        appState.addTerminalOutput('üõë Ejecuci√≥n detenida por el usuario');
        appState.addTerminalOutput('üõë ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        appState.setExecuting(false);
        
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Ejecuci√≥n detenida'),
              backgroundColor: Colors.orange,
            ),
          );
        }
      } else {
        _showError('No se pudo detener la ejecuci√≥n');
      }
    } catch (e) {
      _showError('Error al detener: $e');
    }
  }

  Future<void> _executeScript() async {
    final appState = Provider.of<AppStateProvider>(context, listen: false);

    if (!appState.isRepositoryCloned) {
      _showError('Primero debes clonar el repositorio desde la pesta√±a Git');
      return;
    }

    if (appState.isExecuting) {
      _showError('Ya hay una ejecuci√≥n en curso');
      return;
    }

    // Validaci√≥n pre-ejecuci√≥n
    final canExecute = await _preFlightCheck();
    if (!canExecute) {
      return;
    }

    appState.clearTerminal();
    appState.setExecuting(true);

    if (_selectedScript == null) {
      _showError('Selecciona un script para ejecutar');
      return;
    }

    try {
      await appState.scriptService.executeScript(
        scriptName: _selectedScript!.name,
        displayName: _selectedScript!.displayName,
        onOutput: (line) {
          appState.addTerminalOutput(line);
          _scrollToBottom();
        },
        onComplete: () {
          appState.setExecuting(false);
          _showSuccess('Ejecuci√≥n completada');
        },
        onError: (error) {
          appState.setExecuting(false);
          _showError('Error: $error');
        },
      );
    } catch (e) {
      appState.setExecuting(false);
      _showError('Error ejecutando script: $e');
    }
  }

  Future<bool> _preFlightCheck() async {
    final appState = Provider.of<AppStateProvider>(context, listen: false);

    if (_selectedScript == null) {
      _showError('Selecciona un script para ejecutar');
      return false;
    }

    // Mostrar di√°logo de validaci√≥n
    final shouldContinue = await showDialog<bool>(
      context: context,
      barrierDismissible: false,
      builder: (context) => _PreFlightDialog(
        scriptName: _selectedScript!.displayName,
        appState: appState,
      ),
    );

    return shouldContinue ?? false;
  }

  void _showSuccess(String message) {
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(message),
          backgroundColor: Colors.green,
          behavior: SnackBarBehavior.floating,
        ),
      );
    }
  }

  Future<void> _copyToClipboard() async {
    final appState = Provider.of<AppStateProvider>(context, listen: false);

    if (appState.terminalOutput.isEmpty) {
      _showError('No hay contenido para copiar');
      return;
    }

    try {
      await Clipboard.setData(ClipboardData(text: appState.terminalOutput));
      
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                const Icon(Icons.check_circle, color: Colors.white),
                const SizedBox(width: 12),
                Text('${appState.terminalLines.length} l√≠neas copiadas al portapapeles'),
              ],
            ),
            backgroundColor: Colors.green,
            behavior: SnackBarBehavior.floating,
            duration: const Duration(seconds: 2),
          ),
        );
      }
    } catch (e) {
      _showError('Error copiando al portapapeles: $e');
    }
  }

  Future<void> _downloadLogs() async {
    final appState = Provider.of<AppStateProvider>(context, listen: false);

    if (appState.terminalOutput.isEmpty) {
      _showError('No hay logs para descargar');
      return;
    }

    try {
      final result = await FilePicker.platform.saveFile(
        dialogTitle: 'Guardar logs',
        fileName: 'log_${DateTime.now().toString().replaceAll(':', '-').replaceAll('.', '-')}.txt',
        type: FileType.custom,
        allowedExtensions: ['txt'],
      );

      if (result != null) {
        final file = File(result);
        await file.writeAsString(appState.terminalOutput);
        
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('Logs guardados exitosamente')),
          );
        }
      }
    } catch (e) {
      _showError('Error guardando logs: $e');
    }
  }

  void _showError(String message) {
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(message),
          backgroundColor: Colors.red,
          behavior: SnackBarBehavior.floating,
          duration: const Duration(seconds: 4),
        ),
      );
    }
  }

  void _showLineContextMenu(BuildContext context, Offset position, String line) {
    final overlay = Overlay.of(context).context.findRenderObject() as RenderBox;
    
    showMenu(
      context: context,
      position: RelativeRect.fromRect(
        position & const Size(40, 40),
        Offset.zero & overlay.size,
      ),
      items: [
        PopupMenuItem(
          child: const Row(
            children: [
              Icon(Icons.content_copy, size: 18),
              SizedBox(width: 12),
              Text('Copiar l√≠nea'),
            ],
          ),
          onTap: () {
            Clipboard.setData(ClipboardData(text: line));
            Future.delayed(Duration.zero, () {
              if (mounted) {
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(
                    content: Text('L√≠nea copiada al portapapeles'),
                    duration: Duration(seconds: 1),
                    behavior: SnackBarBehavior.floating,
                  ),
                );
              }
            });
          },
        ),
      ],
    );
  }

  @override
  Widget build(BuildContext context) {
    final appState = Provider.of<AppStateProvider>(context);

    return Padding(
      padding: const EdgeInsets.all(16.0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Selector de script
          Card(
            child: Padding(
              padding: const EdgeInsets.all(16.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Icon(
                        Icons.smart_button_outlined,
                        color: Theme.of(context).colorScheme.primary,
                      ),
                      const SizedBox(width: 8),
                      Text(
                        'Script de Automatizaci√≥n',
                        style: Theme.of(context).textTheme.titleLarge,
                      ),
                      const Spacer(),
                      if (_loadingScripts)
                        const SizedBox(
                          width: 16,
                          height: 16,
                          child: CircularProgressIndicator(strokeWidth: 2),
                        )
                      else
                        TextButton.icon(
                          onPressed: _loadAvailableScripts,
                          icon: const Icon(Icons.refresh, size: 18),
                          label: const Text('Recargar'),
                        ),
                    ],
                  ),
                  const SizedBox(height: 16),
                  if (_loadingScripts)
                    const Center(
                      child: Padding(
                        padding: EdgeInsets.all(16.0),
                        child: CircularProgressIndicator(),
                      ),
                    )
                  else if (_availableScripts.isEmpty)
                    Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: Colors.orange.withOpacity(0.1),
                        borderRadius: BorderRadius.circular(8),
                        border: Border.all(color: Colors.orange),
                      ),
                      child: Row(
                        children: [
                          const Icon(Icons.warning, color: Colors.orange),
                          const SizedBox(width: 12),
                          Expanded(
                            child: Text(
                              'No se encontraron scripts. Clona el repositorio primero.',
                              style: Theme.of(context).textTheme.bodyMedium,
                            ),
                          ),
                        ],
                      ),
                    )
                  else
                    Column(
                      crossAxisAlignment: CrossAxisAlignment.stretch,
                      children: [
                        DropdownButtonFormField<AvailableScript>(
                          value: _selectedScript,
                          decoration: InputDecoration(
                            labelText: 'Selecciona un script',
                            prefixIcon: const Icon(Icons.play_circle_outline),
                            border: OutlineInputBorder(
                              borderRadius: BorderRadius.circular(8),
                            ),
                            filled: true,
                          ),
                          items: _availableScripts.map((script) {
                            return DropdownMenuItem(
                              value: script,
                              child: Text(script.displayName),
                            );
                          }).toList(),
                          onChanged: appState.isExecuting
                              ? null
                              : (value) {
                                  setState(() {
                                    _selectedScript = value;
                                  });
                                  // Guardar selecci√≥n en el provider
                                  appState.setSelectedScript(value?.name);
                                },
                        ),
                        const SizedBox(height: 16),
                        Row(
                          children: [
                            Expanded(
                              child: FilledButton.icon(
                                onPressed: (appState.isExecuting || _selectedScript == null)
                                    ? null
                                    : _executeScript,
                                icon: appState.isExecuting
                                    ? const SizedBox(
                                        width: 20,
                                        height: 20,
                                        child: CircularProgressIndicator(
                                          strokeWidth: 2,
                                          color: Colors.white,
                                        ),
                                      )
                                    : const Icon(Icons.play_arrow),
                                style: FilledButton.styleFrom(
                                  padding: const EdgeInsets.symmetric(vertical: 16),
                                ),
                                label: Text(
                                  appState.isExecuting
                                      ? 'Ejecutando...'
                                      : 'Ejecutar Script',
                                  style: const TextStyle(fontSize: 16),
                                ),
                              ),
                            ),
                            if (appState.isExecuting) ...[
                              const SizedBox(width: 12),
                              FilledButton.icon(
                                onPressed: _stopExecution,
                                icon: const Icon(Icons.stop),
                                style: FilledButton.styleFrom(
                                  backgroundColor: Colors.red,
                                  padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 24),
                                ),
                                label: const Text(
                                  'Detener',
                                  style: TextStyle(fontSize: 16),
                                ),
                              ),
                            ],
                          ],
                        ),
                      ],
                    ),
                ],
              ),
            ),
          ),
          const SizedBox(height: 16),

          // Terminal output
          Expanded(
            child: Card(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Padding(
                    padding: const EdgeInsets.all(16.0),
                    child: Row(
                      children: [
                        Icon(
                          Icons.terminal,
                          color: Theme.of(context).colorScheme.primary,
                        ),
                        const SizedBox(width: 8),
                        Text(
                          'Terminal',
                          style: Theme.of(context).textTheme.titleMedium,
                        ),
                        const Spacer(),
                        IconButton(
                          onPressed: appState.terminalOutput.isNotEmpty
                              ? _copyToClipboard
                              : null,
                          icon: const Icon(Icons.content_copy),
                          tooltip: 'Copiar todo al portapapeles',
                        ),
                        IconButton(
                          onPressed: appState.terminalOutput.isNotEmpty
                              ? _downloadLogs
                              : null,
                          icon: const Icon(Icons.download),
                          tooltip: 'Descargar logs',
                        ),
                        IconButton(
                          onPressed: appState.terminalOutput.isNotEmpty
                              ? () => appState.clearTerminal()
                              : null,
                          icon: const Icon(Icons.clear_all),
                          tooltip: 'Limpiar terminal',
                        ),
                      ],
                    ),
                  ),
                  const Divider(height: 1),
                  Expanded(
                    child: Container(
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.black
                          : Colors.grey[900],
                      child: appState.terminalOutput.isEmpty
                          ? Center(
                              child: Text(
                                'Sin salida a√∫n...',
                                style: TextStyle(
                                  color: Colors.grey[600],
                                  fontFamily: 'monospace',
                                ),
                              ),
                            )
                          : ListView.builder(
                              controller: _scrollController,
                              padding: const EdgeInsets.all(16.0),
                              itemCount: appState.terminalLines.length,
                              itemBuilder: (context, index) {
                                final line = appState.terminalLines[index];
                                Color textColor = Colors.grey[300]!;
                                
                                if (line.contains('ERROR') || line.contains('‚ùå')) {
                                  textColor = Colors.red[300]!;
                                } else if (line.contains('‚úì') || line.contains('exitoso')) {
                                  textColor = Colors.green[300]!;
                                } else if (line.contains('===')) {
                                  textColor = Colors.blue[300]!;
                                }

                                return MouseRegion(
                                  cursor: SystemMouseCursors.text,
                                  child: GestureDetector(
                                    onSecondaryTapDown: (details) {
                                      _showLineContextMenu(context, details.globalPosition, line);
                                    },
                                    child: SelectableText(
                                      line,
                                      style: TextStyle(
                                        fontFamily: 'monospace',
                                        fontSize: 12,
                                        color: textColor,
                                      ),
                                    ),
                                  ),
                                );
                              },
                            ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }
}

// Di√°logo de pre-validaci√≥n antes de ejecutar
class _PreFlightDialog extends StatefulWidget {
  final String scriptName;
  final AppStateProvider appState;

  const _PreFlightDialog({
    required this.scriptName,
    required this.appState,
  });

  @override
  State<_PreFlightDialog> createState() => _PreFlightDialogState();
}

class _PreFlightDialogState extends State<_PreFlightDialog> {
  bool _isValidating = true;
  Map<String, dynamic>? _validationResult;

  @override
  void initState() {
    super.initState();
    _performValidation();
  }

  Future<void> _performValidation() async {
    final result = await widget.appState.scriptService.validateWorkspace();
    setState(() {
      _validationResult = result;
      _isValidating = false;
    });
  }

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: Row(
        children: [
          Icon(
            _isValidating ? Icons.hourglass_empty : Icons.checklist,
            color: Theme.of(context).colorScheme.primary,
          ),
          const SizedBox(width: 12),
          const Text('Verificaci√≥n Pre-Ejecuci√≥n'),
        ],
      ),
      content: SizedBox(
        width: 500,
        child: _isValidating
            ? Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  const CircularProgressIndicator(),
                  const SizedBox(height: 16),
                  Text(
                    'Validando entorno de ejecuci√≥n...',
                    style: Theme.of(context).textTheme.bodyMedium,
                  ),
                ],
              )
            : _buildValidationResults(),
      ),
      actions: _isValidating
          ? null
          : [
              TextButton(
                onPressed: () => Navigator.of(context).pop(false),
                child: const Text('Cancelar'),
              ),
              if (_validationResult!['isReady'] as bool)
                FilledButton(
                  onPressed: () => Navigator.of(context).pop(true),
                  child: const Text('Continuar'),
                ),
            ],
    );
  }

  Widget _buildValidationResults() {
    final isReady = _validationResult!['isReady'] as bool;
    final errors = _validationResult!['errors'] as List<String>;
    final warnings = _validationResult!['warnings'] as List<String>;

    return Column(
      mainAxisSize: MainAxisSize.min,
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Estado general
        Container(
          padding: const EdgeInsets.all(12),
          decoration: BoxDecoration(
            color: isReady ? Colors.green.withOpacity(0.1) : Colors.red.withOpacity(0.1),
            borderRadius: BorderRadius.circular(8),
            border: Border.all(
              color: isReady ? Colors.green : Colors.red,
              width: 2,
            ),
          ),
          child: Row(
            children: [
              Icon(
                isReady ? Icons.check_circle : Icons.error,
                color: isReady ? Colors.green : Colors.red,
                size: 32,
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      isReady ? 'Listo para ejecutar' : 'No se puede ejecutar',
                      style: TextStyle(
                        fontWeight: FontWeight.bold,
                        fontSize: 16,
                        color: isReady ? Colors.green : Colors.red,
                      ),
                    ),
                    Text(
                      widget.scriptName,
                      style: Theme.of(context).textTheme.bodyMedium,
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
        
        // Errores
        if (errors.isNotEmpty) ...[
          const SizedBox(height: 16),
          Row(
            children: [
              const Icon(Icons.error_outline, color: Colors.red, size: 20),
              const SizedBox(width: 8),
              Text(
                'Errores cr√≠ticos (${errors.length})',
                style: const TextStyle(
                  fontWeight: FontWeight.bold,
                  color: Colors.red,
                ),
              ),
            ],
          ),
          const SizedBox(height: 8),
          ...errors.map((error) => Padding(
                padding: const EdgeInsets.only(left: 28, bottom: 4),
                child: Row(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text('‚Ä¢ ', style: TextStyle(color: Colors.red)),
                    Expanded(child: Text(error)),
                  ],
                ),
              )),
        ],

        // Advertencias
        if (warnings.isNotEmpty) ...[
          const SizedBox(height: 16),
          Row(
            children: [
              const Icon(Icons.warning_amber, color: Colors.orange, size: 20),
              const SizedBox(width: 8),
              Text(
                'Advertencias (${warnings.length})',
                style: const TextStyle(
                  fontWeight: FontWeight.bold,
                  color: Colors.orange,
                ),
              ),
            ],
          ),
          const SizedBox(height: 8),
          ...warnings.map((warning) => Padding(
                padding: const EdgeInsets.only(left: 28, bottom: 4),
                child: Row(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text('‚Ä¢ ', style: TextStyle(color: Colors.orange)),
                    Expanded(child: Text(warning)),
                  ],
                ),
              )),
        ],

        // Mensaje de ayuda si hay errores
        if (!isReady) ...[
          const SizedBox(height: 16),
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.blue.withOpacity(0.1),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Icon(Icons.info_outline, color: Colors.blue, size: 20),
                const SizedBox(width: 8),
                Expanded(
                  child: Text(
                    'Ve a la pesta√±a Git y clona el repositorio para continuar.',
                    style: Theme.of(context).textTheme.bodySmall,
                  ),
                ),
              ],
            ),
          ),
        ],
      ],
    );
  }
}
